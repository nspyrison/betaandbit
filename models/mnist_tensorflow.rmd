---
title: "Minst, tensorflow in R"
subtitle: ""
author: "Nicholas Spyrison"
date: "11 Apr 2022"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r opts_chunk, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  warning = FALSE, 
  message = FALSE
)
## Working from the content at:
if(F)
  browseURL("https://tensorflow.rstudio.com/guide/tfestimators/examples/mnist/")
```

# Gist

This is looking the MINST dataset, a series of low resolution hand-darwn digits. It is a standard classification set for image analysis where each pixel can be treated as a variable in grey scale [0, 1]. each image is 28x28 or 784 variables, there are 60000 training obs, and 10000 test obs. More advances takes may aggregate over the surround 9 pixels for example to reduce the size of the variables. I am also excited to use `tensorflow`, I think this should be using GPU computing for parallelization and hopefully near linear performance increase.


# Setup

```{r}
require(ggplot2)
require(reshape2)
require(tensorflow)
require(tfestimators)

# initialize data directory
data_dir <- here::here("./models/mnist-data")
dir.create(data_dir, recursive = TRUE, showWarnings = FALSE)

# download the MNIST data sets, and read them into R
sources <- list(
  train = list(
    x = "https://storage.googleapis.com/cvdf-datasets/mnist/train-images-idx3-ubyte.gz",
    y = "https://storage.googleapis.com/cvdf-datasets/mnist/train-labels-idx1-ubyte.gz"
  ),
  test = list(
    x = "https://storage.googleapis.com/cvdf-datasets/mnist/t10k-images-idx3-ubyte.gz",
    y = "https://storage.googleapis.com/cvdf-datasets/mnist/t10k-labels-idx1-ubyte.gz"
  )
)

# read an MNIST file (encoded in IDX format)
read_idx <- function(file) {
  # create binary connection to file
  conn <- gzfile(file, open = "rb")
  on.exit(close(conn), add = TRUE)
  # read the magic number as sequence of 4 bytes
  magic <- readBin(conn, what = "raw", n = 4, endian = "big")
  ndims <- as.integer(magic[[4]])
  # read the dimensions (32-bit integers)
  dims <- readBin(conn, what = "integer", n = ndims, endian = "big")
  # read the rest in as a raw vector
  data <- readBin(conn, what = "raw", n = prod(dims), endian = "big")
  # convert to an integer vector
  converted <- as.integer(data)
  # return plain vector for 1-dim array
  if(length(dims) == 1)
    return(converted)
  # wrap 3D data into matrix
  matrix(converted, nrow = dims[1], ncol = prod(dims[-1]), byrow = TRUE)
}


mnist <- rapply(sources, classes = "character", how = "list", function(url){
  # download + extract the file at the URL
  target <- file.path(data_dir, basename(url))
  if (!file.exists(target))
    download.file(url, target)
  # read the IDX file
  read_idx(target)
})
```

# Structure and vis
```{r}
siz <- object.size(mnist)
print(siz, units="Mb")
str(mnist)
# summary
c(min(mnist$train$x), mean(mnist$train$x), sd(mnist$train$x), max(mnist$train$x))

# convert training data intensities to 0-1 range
mnist$train$x <- mnist$train$x / max(mnist$train$x)
mnist$test$x  <- mnist$test$x / max(mnist$train$x)


# try plotting the pixel intensities for a random sample of 32 images
n <- 36
set.seed(2022)
indices <- sample(nrow(mnist$train$x), size = n)
data <- array(mnist$train$x[indices, ], dim = c(n, 28, 28))
melted <- reshape2::melt(
  data, varnames = c("image", "x", "y"), value.name = "intensity")
ggplot(melted, aes(x = x, y = y, fill = intensity)) +
  geom_tile() +
  scale_fill_continuous(name = "Pixel Intensity") +
  scale_y_reverse() +
  facet_wrap(~ image, nrow = sqrt(n), ncol = sqrt(n)) +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank(),
    panel.spacing = unit(0, "lines"),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  labs(
    title = "MNIST Image Data",
    subtitle = "Visualization of a sample of images contained in MNIST data set.",
    x = NULL,
    y = NULL
  )
```

# Classifer and input functions
```{r, eval=FALSE}
require(tictoc)
# Memory usage is getting quite high, I want to keep an eye on it.
pryr::mem_used() ## 705 Mb,
# yet rstudio and gc() claimed ~ 5.5 Gb, but not on restart

# construct a linear classifier
## Had to download Miniconda[70Mb], free minimal installer for conda, inc python
### Then need tensorflow; tfestimators::install_tensorflow()
# --? restart then fails at end;
# Error: installation of 'python=3.7' into environment 'C:/Users/spyri/AppData/Local/r-miniconda/envs/r-reticulate' failed [error code 1]
### Which of course needed keras; keras::install_keras() --? but then didn't?
# --? restart then fails at end;
# Error: installation of 'python=3.7' into environment 'C:/Users/spyri/AppData/Local/r-miniconda/envs/r-reticulate' failed [error code 1]
tic("classifer")
classifier <- linear_classifier(
  feature_columns = feature_columns(
    column_numeric("x", shape = shape(784L))
  ),
  n_classes = 10L # ie, classify 10 digits
)
toc()

# construct an input function generator
mnist_input_fn <- function(data, ...) {
  input_fn(
    data,
    response = "y",
    features = "x",
    batch_size = 128,
    ...
  )
}
```

Ok, that looks like we need a local instance of Python 3.7, will have to come back to this another time. For now we'll follow though with the example

# Train and evaluate

```{r, eval=FALSE}
# train the classifier
train(classifier, input_fn = mnist_input_fn(mnist$train), steps = 200)

# evaluate the classifier on the test dataset
evaluate(classifier, input_fn = mnist_input_fn(mnist$test), steps = 200)

# use our classifier to predict labels for a subset of the test dataset
predictions <- predict(classifier, input_fn = mnist_input_fn(mnist$test))

# plot predictions versus actual for small subset
n <- 20
indices <- sample(nrow(mnist$test$x), n)
classes <- vapply(indices, function(i) {
  predictions$classes[[i]]
}, character(1))

data <- array(mnist$test$x[indices, ], dim = c(n, 28, 28))
melted <- melt(data, varnames = c("image", "x", "y"), value.name = "intensity")
melted$class <- classes

image_labels <- setNames(
  sprintf("Predicted: %s\nActual: %s", classes, mnist$test$y[indices]),
  1:n
)

ggplot(melted, aes(x = x, y = y, fill = intensity)) +
  geom_tile() +
  scale_y_reverse() +
  facet_wrap(~ image, ncol = 5, labeller = labeller(image = image_labels)) +
  theme(
    panel.spacing = unit(0, "lines"),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  labs(
    title = "MNIST Image Data",
    subtitle = "Visualization of a sample of images contained in MNIST data set.",
    x = NULL,
    y = NULL
  )
```

# Session info

```{r}
## packages used
pkgs <- c(
  "ggplot2",
  "reshape2",
  "tensorflow",
  "tfestimators"
)

## package & session info
devtools::session_info(pkgs)
```

# Related content

- https://tensorflow.rstudio.com/guide/tfestimators/examples/mnist/

